<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.9">
    <title>{% if is_force_delete %}Force Delete{% else %}Permanent Delete{% endif %} - {{ db_name }} | EDGI Portal</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script src="/static/js/tailwind.config.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="icon" href="/static/favicon.ico">
</head>
<body class="bg-background">
    <header class="fixed top-0 left-0 right-0 z-50 bg-header text-white shadow-md">
        <div class="container mx-auto px-4 h-20 flex items-center justify-between">
            <div class="flex items-center">
                <div class="w-10 h-10 flex items-center justify-center mr-3">
                    <i class="ri-{% if is_force_delete %}skull-line{% else %}delete-bin-line{% endif %} text-white ri-2x" aria-hidden="true"></i>
                </div>
                <div class="text-xl font-semibold">
                    {% if is_force_delete %}Force Delete Database{% else %}Permanent Delete{% endif %}
                </div>
            </div>
            <div>
                <a href="{% if is_admin and is_force_delete %}/system-admin{% else %}/manage-databases{% endif %}" 
                   class="text-white hover:text-accent">
                    <i class="ri-arrow-left-line mr-1"></i>
                    {% if is_admin and is_force_delete %}Back to Admin{% else %}Back to Databases{% endif %}
                </a>
            </div>
        </div>
    </header>
    
    <main class="flex-grow pt-20 pb-6">
        <section class="container mx-auto px-4 mt-6">
            <div class="max-w-2xl mx-auto">
                <!-- Critical Warning Card -->
                <div class="bg-red-50 border-2 border-red-300 rounded-card p-6 mb-6 
                    {% if is_force_delete %}border-red-500 bg-red-100{% endif %}">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 {% if is_force_delete %}bg-red-200{% else %}bg-red-100{% endif %} rounded-full flex items-center justify-center mr-4">
                            <i class="ri-{% if is_force_delete %}skull-line text-red-800{% else %}alert-line text-red-600{% endif %} ri-xl"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold {% if is_force_delete %}text-red-900{% else %}text-red-800{% endif %}">
                                {% if is_force_delete %}
                                    ADMIN FORCE DELETE
                                {% else %}
                                    Permanent Database Deletion
                                {% endif %}
                            </h1>
                            <p class="{% if is_force_delete %}text-red-800{% else %}text-red-600{% endif %}">
                                {% if is_force_delete %}
                                    IMMEDIATE AND IRREVERSIBLE
                                {% else %}
                                    This action cannot be undone
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    
                    {% if is_force_delete %}
                        <div class="bg-red-200 border border-red-400 rounded p-3 mb-4">
                            <div class="flex items-center text-red-900">
                                <i class="ri-alarm-warning-line mr-2"></i>
                                <strong>ADMIN WARNING:</strong>
                            </div>
                            <p class="text-red-800 text-sm mt-1">
                                Force delete bypasses normal safety checks and immediately destroys the database, 
                                even if it's not in trash or the restore period hasn't expired.
                            </p>
                        </div>
                    {% endif %}
                    
                    <div class="bg-white rounded border {% if is_force_delete %}border-red-400{% else %}border-red-200{% endif %} p-4">
                        <h2 class="text-lg font-semibold text-gray-900 mb-3">
                            You are about to permanently delete:
                        </h2>
                        
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Database:</span>
                                <span class="font-medium {% if is_force_delete %}text-red-700{% else %}text-red-600{% endif %}">
                                    {{ db_name.replace('_', ' ').title() }}
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Current Status:</span>
                                <span class="font-medium px-2 py-1 rounded text-xs
                                    {% if db_status == 'Published' %}bg-green-100 text-green-800
                                    {% elif db_status == 'Trashed' %}bg-red-100 text-red-800
                                    {% elif db_status == 'Unpublished' %}bg-blue-100 text-blue-800
                                    {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                    {{ db_status }}
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Tables:</span>
                                <span class="font-medium">{{ table_count | default(0) }} data tables</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Records:</span>
                                <span class="font-medium">{{ "{:,}".format(total_records | default(0)) }} total rows</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Size:</span>
                                <span class="font-medium">{{ "%.1f".format(database_size | default(0)) }} KB</span>
                            </div>
                            {% if trashed_at %}
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Trashed On:</span>
                                    <span class="font-medium text-red-600">{{ trashed_at }}</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Error Message -->
                {% if error %}
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
                        <p class="text-sm">{{ error }}</p>
                    </div>
                {% endif %}

                <!-- Deletion Impact Warning -->
                <div class="bg-card rounded-card p-6 border border-border mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        {% if is_force_delete %}
                            What happens during force deletion?
                        {% else %}
                            What happens when you permanently delete this database?
                        {% endif %}
                    </h3>
                    
                    <div class="space-y-3 mb-6">
                        <div class="flex items-start text-sm">
                            <i class="ri-close-circle-line text-red-500 mr-2 mt-0.5"></i>
                            <span>All {{ table_count | default(0) }} data tables will be <strong>permanently destroyed</strong></span>
                        </div>
                        <div class="flex items-start text-sm">
                            <i class="ri-close-circle-line text-red-500 mr-2 mt-0.5"></i>
                            <span>{{ "{:,}".format(total_records | default(0)) }} records will be <strong>lost forever</strong></span>
                        </div>
                        <div class="flex items-start text-sm">
                            <i class="ri-close-circle-line text-red-500 mr-2 mt-0.5"></i>
                            <span>Database file and all custom homepage content will be <strong>completely removed</strong></span>
                        </div>
                        {% if db_status == 'Published' %}
                        <div class="flex items-start text-sm">
                            <i class="ri-close-circle-line text-red-500 mr-2 mt-0.5"></i>
                            <span>Public links to <strong>/{{ db_name }}/</strong> will <strong>permanently break</strong></span>
                        </div>
                        {% endif %}
                        <div class="flex items-start text-sm">
                            <i class="ri-key-line text-blue-500 mr-2 mt-0.5"></i>
                            <span>Database name "{{ db_name }}" will be <strong>released</strong> and can be used again</span>
                        </div>
                        {% if is_force_delete %}
                        <div class="flex items-start text-sm">
                            <i class="ri-shield-cross-line text-red-500 mr-2 mt-0.5"></i>
                            <span><strong>Force delete bypasses all safety checks</strong> - immediate destruction</span>
                        </div>
                        {% else %}
                        <div class="flex items-start text-sm">
                            <i class="ri-time-line text-orange-500 mr-2 mt-0.5"></i>
                            <span>No recovery period - this is the <strong>final step</strong> in the deletion process</span>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Critical Confirmation Input -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            {% if is_force_delete and is_admin %}
                                Type <strong class="text-red-700 bg-red-100 px-2 py-1 rounded">FORCE DELETE</strong> to confirm:
                            {% else %}
                                Type the database name <strong class="text-red-700 bg-red-100 px-2 py-1 rounded">{{ db_name }}</strong> to confirm deletion:
                            {% endif %}
                        </label>
                        <input type="text" id="confirmation-input" 
                               class="w-full p-3 border-2 border-red-300 rounded focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 text-lg font-mono"
                               placeholder="{% if is_force_delete and is_admin %}Enter FORCE DELETE exactly{% else %}Enter database name exactly{% endif %}"
                               autocomplete="off">
                        <p class="text-red-600 text-xs mt-1">
                            {% if is_force_delete and is_admin %}
                                Must type "FORCE DELETE" exactly as shown (case sensitive)
                            {% else %}
                                Must match exactly: {{ db_name }}
                            {% endif %}
                        </p>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex flex-col sm:flex-row gap-3">
                        <form method="post" class="flex-1" onsubmit="return confirmDeletion(event)">
                            <input type="hidden" name="csrftoken" value="{{ csrftoken() }}">
                            <input type="hidden" name="confirm_input" id="hidden-confirm" value="">
                            <button type="submit" id="delete-button" disabled
                                    class="w-full {% if is_force_delete %}bg-red-800 hover:bg-red-900{% else %}bg-red-600 hover:bg-red-700{% endif %} text-white py-3 px-4 rounded-button disabled:bg-gray-400 disabled:cursor-not-allowed transition font-medium text-lg">
                                <i class="ri-{% if is_force_delete %}skull-line{% else %}delete-bin-line{% endif %} mr-2"></i>
                                {% if is_force_delete %}
                                    FORCE DELETE DATABASE IMMEDIATELY
                                {% else %}
                                    DELETE DATABASE PERMANENTLY
                                {% endif %}
                            </button>
                        </form>
                        
                        <div class="flex-1">
                            <a href="{% if is_admin and is_force_delete %}/system-admin{% else %}/manage-databases{% endif %}" 
                               class="w-full bg-gray-200 text-gray-800 py-3 px-4 rounded-button hover:bg-gray-300 transition text-center font-medium text-lg block">
                                <i class="ri-close-line mr-2"></i>Cancel & Keep Database
                            </a>
                        </div>
                    </div>

                    <!-- Alternative Actions for Non-Trashed Databases -->
                    {% if db_status != 'Trashed' and not is_force_delete %}
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <h4 class="text-sm font-medium text-gray-700 mb-3">Consider safer alternatives first:</h4>
                        <div class="flex flex-wrap gap-2">
                            {% if db_status == 'Published' %}
                                <form method="post" action="/db/{{ db_name }}/unpublish" class="inline">
                                    <input type="hidden" name="csrftoken" value="{{ csrftoken() }}">
                                    <button type="submit" class="bg-blue-500 text-white px-3 py-2 rounded-button hover:bg-blue-600 transition text-sm">
                                        <i class="ri-eye-off-line mr-1"></i>Just Unpublish Instead
                                    </button>
                                </form>
                            {% endif %}
                            <a href="/db/{{ db_name }}/trash" 
                               class="bg-yellow-500 text-white px-3 py-2 rounded-button hover:bg-yellow-600 transition text-sm">
                                <i class="ri-delete-bin-line mr-1"></i>Move to Trash (30-day recovery)
                            </a>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Data Export Reminder -->
                    {% if table_count > 0 and db_status == 'Published' %}
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <h4 class="text-sm font-medium text-gray-700 mb-3">Last chance to backup your data:</h4>
                        <div class="flex flex-wrap gap-2">
                            <a href="/{{ db_name }}" target="_blank"
                               class="text-green-600 hover:text-green-800 text-sm flex items-center">
                                <i class="ri-database-line mr-1"></i>View all tables
                            </a>
                            <a href="/{{ db_name }}.json" target="_blank"
                               class="text-blue-600 hover:text-blue-800 text-sm flex items-center">
                                <i class="ri-download-line mr-1"></i>Export as JSON
                            </a>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Admin Override Warning -->
                {% if is_force_delete and is_admin %}
                <div class="bg-red-100 border border-red-400 rounded-card p-6">
                    <h3 class="text-lg font-semibold text-red-800 mb-4">
                        <i class="ri-admin-line mr-2"></i>Administrator Override Active
                    </h3>
                    <div class="space-y-2 text-red-700 text-sm">
                        <div class="flex items-start">
                            <i class="ri-arrow-right-s-line mt-0.5 mr-1"></i>
                            <span>You are using administrator privileges to force delete this database</span>
                        </div>
                        <div class="flex items-start">
                            <i class="ri-arrow-right-s-line mt-0.5 mr-1"></i>
                            <span>This bypasses normal safety checks and trash bin requirements</span>
                        </div>
                        <div class="flex items-start">
                            <i class="ri-arrow-right-s-line mt-0.5 mr-1"></i>
                            <span>The database owner will be notified of this administrative action</span>
                        </div>
                        <div class="flex items-start">
                            <i class="ri-arrow-right-s-line mt-0.5 mr-1"></i>
                            <span>This action will be logged in the system audit trail</span>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </section>
    </main>

    <footer class="bg-gray-50 border-t border-gray-100 py-8">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center mb-4 md:mb-0">
                    <div class="w-8 h-8 flex items-center justify-center mr-2">
                        <i class="ri-earth-line text-primary ri-lg" aria-hidden="true"></i>
                    </div>
                    <p class="text-primary">
                        Made with <span class="text-red-500" aria-label="love">❤</span> by 
                        <a href="https://envirodatagov.org" rel="nofollow" class="text-accent hover:text-primary">EDGI</a> and 
                        <a href="https://screening-tools.com/" rel="nofollow" class="text-accent hover:text-primary">Public Environmental Data Partners</a>.
                    </p>
                </div>
                <div>
                    <a href="https://opendatacommons.org/licenses/odbl/" class="text-accent hover:text-primary">Data licensed under ODbL</a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        const confirmationInput = document.getElementById('confirmation-input');
        const deleteButton = document.getElementById('delete-button');
        const hiddenConfirm = document.getElementById('hidden-confirm');
        const requiredText = '{{ required_confirmation }}';
        const isForceDelete = {{ 'true' if is_force_delete else 'false' }};

        // Enable delete button only when correct text is entered
        confirmationInput.addEventListener('input', function() {
            const inputValue = this.value.trim();
            const isMatch = inputValue === requiredText;
            deleteButton.disabled = !isMatch;
            hiddenConfirm.value = inputValue;
            
            if (isMatch) {
                deleteButton.classList.remove('bg-gray-400');
                if (isForceDelete) {
                    deleteButton.classList.add('bg-red-800', 'hover:bg-red-900');
                } else {
                    deleteButton.classList.add('bg-red-600', 'hover:bg-red-700');
                }
                // Visual feedback for correct input
                confirmationInput.classList.remove('border-red-300');
                confirmationInput.classList.add('border-green-500', 'bg-green-50');
            } else {
                deleteButton.classList.add('bg-gray-400');
                deleteButton.classList.remove('bg-red-600', 'hover:bg-red-700', 'bg-red-800', 'hover:bg-red-900');
                // Reset input styling
                confirmationInput.classList.remove('border-green-500', 'bg-green-50');
                confirmationInput.classList.add('border-red-300');
            }
        });

        // Final confirmation before deletion
        function confirmDeletion(event) {
            if (confirmationInput.value.trim() !== requiredText) {
                event.preventDefault();
                alert('Please enter the exact confirmation text to proceed with deletion.');
                confirmationInput.focus();
                return false;
            }
            
            const dbName = '{{ db_name }}';
            const tableCount = {{ table_count | default(0) }};
            const recordCount = {{ total_records | default(0) }};
            
            let confirmMessage;
            if (isForceDelete) {
                confirmMessage = 
                    `ADMIN FORCE DELETE CONFIRMATION\n\n` +
                    `You are about to IMMEDIATELY and PERMANENTLY delete:\n` +
                    `Database: "${dbName}"\n` +
                    `Tables: ${tableCount}\n` +
                    `Records: ${recordCount.toLocaleString()}\n\n` +
                    `⚠️  CRITICAL WARNING ⚠️\n` +
                    `• This bypasses all safety checks\n` +
                    `• No recovery period or trash bin\n` +
                    `• Database owner will be notified\n` +
                    `• Action will be audit logged\n\n` +
                    `Are you absolutely certain you want to proceed?`;
            } else {
                confirmMessage = 
                    `FINAL DELETION CONFIRMATION\n\n` +
                    `This will permanently delete:\n` +
                    `Database: "${dbName}"\n` +
                    `Tables: ${tableCount}\n` +
                    `Records: ${recordCount.toLocaleString()}\n\n` +
                    `⚠️  THIS CANNOT BE UNDONE ⚠️\n\n` +
                    `Are you absolutely sure you want to proceed?`;
            }
            
            const finalConfirm = confirm(confirmMessage);
            
            if (!finalConfirm) {
                event.preventDefault();
                return false;
            }
            
            // Show loading state
            deleteButton.innerHTML = `<i class="ri-loader-line animate-spin mr-2"></i>${isForceDelete ? 'Force Deleting...' : 'Deleting Database...'}`;
            deleteButton.disabled = true;
            
            // Disable navigation during deletion
            window.addEventListener('beforeunload', function(e) {
                e.preventDefault();
                e.returnValue = 'Database deletion in progress...';
            });
            
            return true;
        }

        // Focus on confirmation input and select any existing text
        confirmationInput.focus();
        confirmationInput.select();

        // Prevent accidental navigation
        let hasConfirmed = false;
        
        window.addEventListener('beforeunload', function(e) {
            if (!hasConfirmed && confirmationInput.value.trim() === requiredText) {
                e.preventDefault();
                e.returnValue = 'You have entered the confirmation text but haven\'t submitted the form. Are you sure you want to leave?';
            }
        });

        // Add dramatic visual feedback for force delete
        if (isForceDelete) {
            // Pulse effect for force delete warning
            const header = document.querySelector('header');
            setInterval(() => {
                header.style.background = header.style.background === 'rgb(127, 29, 29)' ? '' : 'rgb(127, 29, 29)';
            }, 2000);
        }
    </script>
</body>
</html>