<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.9">
    <title>Upload Data - {{ db_name }} | EDGI Portal</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script src="/static/js/tailwind.config.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="icon" href="/static/favicon.ico">
</head>
<body class="bg-background">
    <header class="fixed top-0 left-0 right-0 z-50 bg-header text-white shadow-md">
        <div class="container mx-auto px-4 h-20 flex items-center justify-between">
            <div class="flex items-center">
                <div class="w-10 h-10 flex items-center justify-center mr-3">
                    <i class="ri-upload-cloud-line text-white ri-2x" aria-hidden="true"></i>
                </div>
                <div class="text-xl font-semibold">Upload Data to {{ db_name.replace('_', ' ').title() }}</div>
            </div>
            <div>
                <a href="/manage-databases" class="text-white hover:text-accent mr-4">
                    <i class="ri-arrow-left-line mr-1"></i>Back to Databases
                </a>
                <a href="/logout" class="text-white hover:text-accent">Logout</a>
            </div>
        </div>
    </header>
    
    <main class="flex-grow pt-20 pb-6">
        <section class="container mx-auto px-4 mt-6">
            <div class="max-w-4xl mx-auto">
                <!-- Header -->
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-primary mb-4">Upload Data</h1>
                    <p class="text-textlight">Add data to your {{ db_name.replace('_', ' ').title() }} database from multiple sources</p>
                </div>

                <!-- Success/Error Messages -->
                {% if success %}
                    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-6">
                        {% set decoded_success = success %}
                        {% if "ULTRA-FAST:" in decoded_success or "Successfully uploaded" in decoded_success %}
                            <div class="flex items-center">
                                <i class="ri-check-circle-line text-green-600 text-lg mr-2"></i>
                                <div>
                                    <p class="text-sm font-medium">{{ decoded_success }}</p>
                                    {% if "rows/sec" in decoded_success %}
                                        <p class="text-xs text-green-600 mt-1">
                                            <i class="ri-dashboard-3-line mr-1"></i>
                                            High-performance upload completed successfully
                                        </p>
                                    {% endif %}
                                </div>
                            </div>
                        {% else %}
                            <p class="text-sm">{{ decoded_success }}</p>
                        {% endif %}
                    </div>
                {% endif %}

                {% if error %}
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
                        {% set decoded_error = error %}
                        <p class="text-sm font-medium">{{ decoded_error }}</p>
                        
                        <!-- Enhanced error guidance -->
                        {% if "Google Sheet is private" in decoded_error %}
                            <div class="mt-2 text-xs">
                                <strong>How to fix:</strong> 
                                <ol class="list-decimal list-inside mt-1">
                                    <li>Open your Google Sheet</li>
                                    <li>Click "Share" button (top right)</li>
                                    <li>Change to "Anyone with the link can view"</li>
                                    <li>Copy the share link and try again</li>
                                </ol>
                            </div>
                        {% elif "Domain" in decoded_error and "blocked" in decoded_error %}
                            <div class="mt-2 text-xs">
                                <strong>Domain blocked:</strong> Contact admin to request domain approval.
                            </div>
                        {% elif "type 'Timestamp' is not supported" in decoded_error %}
                            <div class="mt-2 text-xs">
                                <strong>How to fix:</strong> This Excel file contains date/time columns that need to be converted. Try saving as CSV first, or the system will automatically convert them on retry.
                            </div>
                        {% endif %}
                    </div>
                {% endif %}

                <!-- Upload Progress Overlay with Real Progress Bar -->
                <div id="upload-progress-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                        <div class="text-center">
                            <div class="mb-4">
                                <i id="progress-icon" class="ri-upload-cloud-line text-5xl text-blue-500"></i>
                            </div>
                            <h3 class="text-lg font-semibold mb-2" id="progress-title">Processing Upload...</h3>
                            <p class="text-gray-600 text-sm mb-4" id="progress-message">Please wait while your data is being processed.</p>
                            
                            <!-- Real Progress Bar -->
                            <div class="mb-4">
                                <div class="flex justify-between text-xs text-gray-600 mb-1">
                                    <span id="progress-percentage">0%</span>
                                    <span id="progress-speed"></span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div id="progress-bar" class="bg-blue-500 h-3 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
                                </div>
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span id="progress-transferred">0 MB / 0 MB</span>
                                    <span id="progress-time">Elapsed: 0s</span>
                                </div>
                            </div>
                            
                            <!-- Upload Details -->
                            <div id="upload-details" class="text-xs text-gray-600 mb-4 hidden">
                                <div class="flex justify-between">
                                    <span>File:</span>
                                    <span id="upload-filename"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Size:</span>
                                    <span id="upload-filesize"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span>ETA:</span>
                                    <span id="upload-eta">Calculating...</span>
                                </div>
                            </div>
                            
                            <!-- Cancel Button -->
                            <button id="cancel-upload-btn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition text-sm">
                                <i class="ri-close-line mr-1"></i>Cancel Upload
                            </button>
                            
                            <!-- Success/Error Display -->
                            <div id="upload-result" class="hidden mt-4 p-3 rounded">
                                <div id="upload-result-content"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload Source Tabs -->
                <div class="bg-card rounded-card border border-border mb-6">
                    <div class="border-b border-border">
                        <nav class="flex">
                            <button onclick="showUploadTab('file')" id="file-tab" 
                                    class="upload-tab active px-6 py-4 font-medium text-accent border-b-2 border-accent">
                                <i class="ri-file-upload-line mr-2"></i>Upload File
                            </button>
                            <button onclick="showUploadTab('sheets')" id="sheets-tab" 
                                    class="upload-tab px-6 py-4 font-medium text-textlight hover:text-accent">
                                <i class="ri-table-line mr-2"></i>Google Sheets
                            </button>
                            <button onclick="showUploadTab('url')" id="url-tab" 
                                    class="upload-tab px-6 py-4 font-medium text-textlight hover:text-accent">
                                <i class="ri-global-line mr-2"></i>Web CSV
                            </button>
                        </nav>
                    </div>

                    <!-- File Upload Panel -->
                    <div id="file-panel" class="upload-panel p-6">
                        <form id="file-upload-form" onsubmit="return handleFileUpload(event)">
                            <input type="hidden" name="csrftoken" value="{{ csrftoken() }}">
                            <input type="hidden" name="source_type" value="file">
                            
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- File Selection -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Select File
                                    </label>
                                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-accent transition">
                                        <input type="file" name="file" id="file-input" 
                                            accept=".csv,.txt,.tsv,.xlsx,.xls" 
                                            class="hidden" onchange="handleFileSelect(this)">
                                        <label for="file-input" class="cursor-pointer">
                                            <i class="ri-upload-cloud-2-line text-4xl text-gray-400 mb-2 block"></i>
                                            <p class="text-gray-600">Click to select file</p>
                                            <p class="text-xs text-gray-500 mt-1">Supports CSV, TSV, TXT, Excel (.xlsx, .xls) files up to {{ (system_settings.max_file_size // (1024*1024)) }}MB</p>
                                        </label>
                                        <div id="file-info" class="hidden mt-4 p-3 bg-blue-50 rounded border">
                                            <p class="text-sm text-blue-800" id="file-details"></p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Upload Options -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Table Name (Optional)
                                    </label>
                                    <input type="text" name="table_name" id="table-name" 
                                        class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-accent"
                                        placeholder="Auto-generated from filename">
                                    <p class="text-xs text-gray-500 mt-1">Leave blank to use filename. Must be unique in database.</p>

                                    <!-- Excel First Sheet -->
                                    <div id="excel-options" class="hidden mt-4">
                                        <div class="bg-blue-50 border border-blue-200 rounded p-3">
                                            <p class="text-sm text-blue-800">
                                                <i class="ri-information-line mr-1"></i>
                                                <strong>Excel File Detected:</strong> Only the first sheet will be processed.
                                            </p>
                                            <p class="text-xs text-blue-600 mt-1">
                                                If your data is in another sheet, please move it to the first sheet or save that sheet as a separate file.
                                            </p>
                                        </div>
                                    </div>

                                    <div class="mt-4">
                                        <label class="flex items-center">
                                            <input type="checkbox" name="replace_existing" class="mr-2">
                                            <span class="text-sm text-gray-700">Replace existing table if name conflicts</span>
                                        </label>
                                    </div>

                                    <div class="mt-6">
                                        <button type="submit" id="file-upload-btn"
                                                class="w-full bg-accent text-white py-3 px-4 rounded-button hover:bg-primary transition font-medium">
                                            <i class="ri-upload-line mr-2" id="file-upload-icon"></i>
                                            <span id="file-upload-text">Upload File</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Google Sheets Panel -->
                    <div id="sheets-panel" class="upload-panel p-6 hidden">
                        <form id="sheets-upload-form" onsubmit="return handleSheetsUpload(event)">
                            <input type="hidden" name="csrftoken" value="{{ csrftoken() }}">
                            <input type="hidden" name="source_type" value="sheets">
                            
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- Google Sheets URL -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Google Sheets URL
                                    </label>
                                    <input type="url" name="sheets_url" id="sheets-url" 
                                        class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-accent"
                                        placeholder="https://docs.google.com/spreadsheets/d/...">
                                    <div class="text-xs text-gray-500 mt-1">
                                        <p><strong>Important:</strong> The sheet must be publicly accessible.</p>
                                        <p class="mt-1"><strong>How to share:</strong></p>
                                        <ol class="list-decimal list-inside mt-1">
                                            <li>Open your Google Sheet</li>
                                            <li>Click "Share" (top right)</li>
                                            <li>Change to "Anyone with the link can view"</li>
                                            <li>Copy the link and paste it here</li>
                                        </ol>
                                    </div>

                                    <!-- Sheet Detection -->
                                    <div class="mt-4">
                                        <button type="button" onclick="detectSheets()" 
                                                class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition text-sm">
                                            <i class="ri-search-line mr-1"></i>Test Connection
                                        </button>
                                        <div id="sheets-info" class="hidden mt-3 p-3 bg-green-50 rounded border">
                                            <p class="text-sm text-green-800" id="sheets-details"></p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Import Options -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Sheet Selection
                                    </label>
                                    <select name="sheet_index" id="sheet-select" 
                                            class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-accent">
                                        <option value="0">First Sheet (Default)</option>
                                    </select>

                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Table Name (Optional)
                                        </label>
                                        <input type="text" name="table_name" id="sheets-table-name" 
                                            class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-accent"
                                            placeholder="Auto-generated from sheet name">
                                    </div>

                                    <div class="mt-4">
                                        <label class="flex items-center">
                                            <input type="checkbox" name="first_row_headers" checked class="mr-2">
                                            <span class="text-sm text-gray-700">First row contains headers</span>
                                        </label>
                                    </div>

                                    <div class="mt-2">
                                        <label class="flex items-center">
                                            <input type="checkbox" name="replace_existing" class="mr-2">
                                            <span class="text-sm text-gray-700">Replace existing table if name conflicts</span>
                                        </label>
                                    </div>

                                    <div class="mt-6">
                                        <button type="submit" id="sheets-upload-btn"
                                                class="w-full bg-accent text-white py-3 px-4 rounded-button hover:bg-primary transition font-medium">
                                            <i class="ri-download-cloud-line mr-2" id="sheets-upload-icon"></i>
                                            <span id="sheets-upload-text">Import from Google Sheets</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Web CSV Panel -->
                    <div id="url-panel" class="upload-panel p-6 hidden">
                        <form id="url-upload-form" onsubmit="return handleUrlUpload(event)">
                            <input type="hidden" name="csrftoken" value="{{ csrftoken() }}">
                            <input type="hidden" name="source_type" value="url">
                            
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- URL Input -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        CSV File URL
                                    </label>
                                    <input type="url" name="csv_url" id="csv-url" 
                                        class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-accent"
                                        placeholder="https://example.com/data.csv">
                                    <div class="text-xs text-gray-500 mt-1">
                                        <p><strong>Supported:</strong> Most domains are allowed unless blocked by admin.</p>
                                        <p class="mt-1">URL must point directly to a CSV file. Raw URLs work best.</p>
                                        <p class="mt-1">Contact admin if your domain is blocked.</p>
                                    </div>

                                    <!-- URL Validation -->
                                    <div class="mt-4">
                                        <button type="button" onclick="validateUrl()" 
                                                class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition text-sm">
                                            <i class="ri-check-line mr-1"></i>Test URL
                                        </button>
                                        <div id="url-info" class="hidden mt-3 p-3 bg-green-50 rounded border">
                                            <p class="text-sm text-green-800" id="url-details"></p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Import Options -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Table Name (Optional)
                                    </label>
                                    <input type="text" name="table_name" id="url-table-name" 
                                        class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-accent"
                                        placeholder="Auto-generated from URL">

                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Encoding
                                        </label>
                                        <select name="encoding" class="w-full p-3 border border-gray-300 rounded">
                                            <option value="auto">Auto-detect</option>
                                            <option value="utf-8">UTF-8</option>
                                            <option value="latin-1">Latin-1</option>
                                            <option value="ascii">ASCII</option>
                                        </select>
                                    </div>

                                    <div class="mt-4">
                                        <label class="flex items-center">
                                            <input type="checkbox" name="replace_existing" class="mr-2">
                                            <span class="text-sm text-gray-700">Replace existing table if name conflicts</span>
                                        </label>
                                    </div>

                                    <div class="mt-6">
                                        <button type="submit" id="url-upload-btn"
                                                class="w-full bg-accent text-white py-3 px-4 rounded-button hover:bg-primary transition font-medium">
                                            <i class="ri-download-line mr-2" id="url-upload-icon"></i>
                                            <span id="url-upload-text">Import from URL</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Enhanced Help Section -->
                <div class="bg-blue-50 border border-blue-200 rounded-card p-6 mt-6">
                    <h3 class="text-lg font-semibold text-blue-800 mb-4">
                        <i class="ri-information-line mr-2"></i>Upload Guidelines & Troubleshooting
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-blue-700">
                        <div>
                            <div class="font-semibold text-blue-800 mb-2">File Uploads</div>
                            <ul class="space-y-1">
                                <li>• Maximum file size: {{ (system_settings.max_file_size // (1024*1024)) }}MB</li>
                                <li>• Supported formats: CSV, TSV, TXT</li>
                                <li>• Excel files: .xlsx, .xls</li>
                                <li>• UTF-8 encoding recommended</li>
                                <li>• First row should contain headers</li>
                            </ul>
                            <div class="mt-2 text-xs">
                                <strong>Performance:</strong> Ultra-optimized processing for large files (100MB+) with speeds up to 150,000+ rows/sec.
                            </div>
                        </div>
                        <div>
                            <div class="font-semibold text-blue-800 mb-2">Google Sheets</div>
                            <ul class="space-y-1">
                                <li>• Sheet must be publicly accessible</li>
                                <li>• Use "Anyone with link can view"</li>
                                <li>• Supports multiple sheets per document</li>
                                <li>• Automatically detects data ranges</li>
                            </ul>
                            <div class="mt-2 text-xs">
                                <strong>Common Issue:</strong> 401 Unauthorized means the sheet is private. Make it public to fix.
                            </div>
                        </div>
                        <div>
                            <div class="font-semibold text-blue-800 mb-2">Web CSV</div>
                            <ul class="space-y-1">
                                <li>• Most domains are supported</li>
                                <li>• Must point directly to CSV file</li>
                                <li>• Raw URLs work best</li>
                                <li>• Some domains may be blocked by admin</li>
                            </ul>
                            <div class="mt-2 text-xs">
                                <strong>Domain Blocked?</strong> Contact admin if your domain is restricted.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // Enhanced UploadManager with better cancel button handling
        class UploadManager {
            constructor() {
                this.currentXHR = null;
                this.startTime = null;
                this.progressTimer = null;
                this.isUploading = false;
                this.currentUploadId = null;
                this.abortController = null;
                this.isCancelling = false;
                this.cancelRequested = false;
                this.cancelTimeoutId = null;
            }

            generateUploadId(type) {
                // Generate unique upload ID with user ID, database name, and timestamp
                const userId = '{{ actor.id }}';
                const dbName = '{{ db_name }}';
                const timestamp = Date.now();
                return `${userId}_${dbName}_${timestamp}_${type}`;
            }

            showProgress(title, message, type = 'file', filename = '', filesize = '') {
                const overlay = document.getElementById('upload-progress-overlay');
                const progressTitle = document.getElementById('progress-title');
                const progressMessage = document.getElementById('progress-message');
                const progressIcon = document.getElementById('progress-icon');
                const uploadDetails = document.getElementById('upload-details');
                const uploadFilename = document.getElementById('upload-filename');
                const uploadFilesize = document.getElementById('upload-filesize');
                const uploadResult = document.getElementById('upload-result');
                const cancelButton = document.getElementById('cancel-upload-btn');

                // Set content
                progressTitle.textContent = title;
                progressMessage.textContent = message;
                
                // Set appropriate icon
                const iconClass = type === 'sheets' ? 'ri-table-line' : 
                                type === 'url' ? 'ri-global-line' : 'ri-upload-cloud-line';
                progressIcon.className = `${iconClass} text-5xl text-blue-500`;
                
                // Show file details for file uploads
                if (filename && filesize) {
                    uploadFilename.textContent = filename;
                    uploadFilesize.textContent = filesize;
                    uploadDetails.classList.remove('hidden');
                } else {
                    uploadDetails.classList.add('hidden');
                }
                
                // Reset progress and states
                this.resetProgress();
                uploadResult.classList.add('hidden');
                this.isCancelling = false;
                this.cancelRequested = false;
                
                // Clear any existing cancel timeout
                if (this.cancelTimeoutId) {
                    clearTimeout(this.cancelTimeoutId);
                    this.cancelTimeoutId = null;
                }
                
                // CRITICAL: Reset and enable cancel button properly
                if (cancelButton) {
                    cancelButton.classList.remove('hidden');
                    cancelButton.style.display = 'inline-block';
                    cancelButton.style.pointerEvents = 'auto';
                    cancelButton.disabled = false;
                    cancelButton.innerHTML = '<i class="ri-close-line mr-1"></i>Cancel Upload';
                    cancelButton.className = 'bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition text-sm';
                }
                
                // Show overlay
                overlay.classList.remove('hidden');
                this.isUploading = true;
                this.startTime = Date.now();
                this.startTimer();
            }

            hideProgress() {
                const overlay = document.getElementById('upload-progress-overlay');
                const cancelButton = document.getElementById('cancel-upload-btn');
                
                // Hide the overlay
                overlay.classList.add('hidden');
                
                // Clear all timers
                if (this.progressTimer) {
                    clearInterval(this.progressTimer);
                    this.progressTimer = null;
                }
                
                if (this.cancelTimeoutId) {
                    clearTimeout(this.cancelTimeoutId);
                    this.cancelTimeoutId = null;
                }
                
                // Reset all states completely
                this.isUploading = false;
                this.isCancelling = false;
                this.cancelRequested = false;
                this.currentXHR = null;
                this.currentUploadId = null;
                this.abortController = null;
                this.startTime = null;
                
                // Reset cancel button to default state
                if (cancelButton) {
                    cancelButton.disabled = false;
                    cancelButton.style.pointerEvents = 'auto';
                    cancelButton.classList.remove('hidden');
                    cancelButton.innerHTML = '<i class="ri-close-line mr-1"></i>Cancel Upload';
                    cancelButton.className = 'bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition text-sm';
                }
                
                // Reset progress bar and other UI elements
                this.resetProgress();
                
                // Hide result area
                const uploadResult = document.getElementById('upload-result');
                if (uploadResult) {
                    uploadResult.classList.add('hidden');
                }
                
                console.log('Progress dialog fully reset and hidden');
            }
            
            resetProgress() {
                const progressBar = document.getElementById('progress-bar');
                
                // Reset to normal progress bar styling
                progressBar.style.width = '0%';
                progressBar.style.background = '#3b82f6';  // Solid blue
                progressBar.style.backgroundSize = 'auto';
                progressBar.style.animation = 'none';
                
                document.getElementById('progress-percentage').textContent = '0%';
                document.getElementById('progress-transferred').textContent = '0 MB / 0 MB';
                document.getElementById('progress-speed').textContent = '';
                document.getElementById('upload-eta').textContent = 'Calculating...';
            }
            
            showIndeterminateProgress() {
                const progressBar = document.getElementById('progress-bar');
                const progressPercentage = document.getElementById('progress-percentage');
                const progressTransferred = document.getElementById('progress-transferred');
                const progressSpeed = document.getElementById('progress-speed');
                const uploadEta = document.getElementById('upload-eta');
                const cancelButton = document.getElementById('cancel-upload-btn');
                
                // Hide specific progress details for non-file uploads
                progressPercentage.textContent = '';
                progressTransferred.textContent = 'Processing...';
                progressSpeed.textContent = '';
                uploadEta.textContent = 'Please wait...';
                
                // IMPORTANT: Make sure cancel button is VISIBLE
                if (cancelButton) {
                    cancelButton.classList.remove('hidden');
                    cancelButton.style.display = 'inline-block';
                }
                
                // Show pulsing animation instead of percentage-based progress
                progressBar.style.width = '100%';
                progressBar.style.background = 'linear-gradient(90deg, #3b82f6, #1d4ed8, #3b82f6)';
                progressBar.style.backgroundSize = '200% 100%';
                progressBar.style.animation = 'pulse-gradient 2s ease-in-out infinite';
                
                // Add the CSS animation if it doesn't exist
                if (!document.getElementById('pulse-gradient-style')) {
                    const style = document.createElement('style');
                    style.id = 'pulse-gradient-style';
                    style.textContent = `
                        @keyframes pulse-gradient {
                            0% { background-position: 200% 0; opacity: 0.6; }
                            50% { background-position: 0% 0; opacity: 1; }
                            100% { background-position: -200% 0; opacity: 0.6; }
                        }
                    `;
                    document.head.appendChild(style);
                }
            }

            updateProgress(loaded, total) {
                if (!this.isUploading || this.isCancelling) return;

                // Only update for real file uploads with progress data
                if (!loaded || !total || loaded === 0 || total === 0) return;

                const percentage = Math.round((loaded / total) * 100);
                const loadedMB = (loaded / 1024 / 1024).toFixed(1);
                const totalMB = (total / 1024 / 1024).toFixed(1);
                
                // Update progress bar
                document.getElementById('progress-bar').style.width = percentage + '%';
                document.getElementById('progress-percentage').textContent = percentage + '%';
                document.getElementById('progress-transferred').textContent = `${loadedMB} MB / ${totalMB} MB`;
                
                // Calculate speed and ETA
                const elapsed = (Date.now() - this.startTime) / 1000;
                const speed = loaded / elapsed; // bytes per second
                const speedMBs = (speed / 1024 / 1024).toFixed(1);
                const remaining = (total - loaded) / speed;
                
                document.getElementById('progress-speed').textContent = `${speedMBs} MB/s`;
                
                if (remaining > 0 && remaining < Infinity) {
                    const eta = remaining < 60 ? `${Math.round(remaining)}s` : 
                            remaining < 3600 ? `${Math.round(remaining/60)}m` : 
                            `${Math.round(remaining/3600)}h`;
                    document.getElementById('upload-eta').textContent = eta;
                }
            }

            startTimer() {
                const progressTime = document.getElementById('progress-time');
                this.progressTimer = setInterval(() => {
                    if (this.startTime) {
                        const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                        progressTime.textContent = `Elapsed: ${elapsed}s`;
                    }
                }, 1000);
            }

            cancelUpload() {
                // Prevent multiple cancellation attempts
                if (this.isCancelling || this.cancelRequested) {
                    console.log('Cancellation already in progress, ignoring duplicate request');
                    return;
                }
                
                this.isCancelling = true;
                this.cancelRequested = true;
                
                const cancelTime = new Date().toISOString();
                const elapsedSeconds = this.startTime ? (Date.now() - this.startTime) / 1000 : 0;
                
                console.log('FRONTEND CANCEL INITIATED:', {
                    cancelTime: cancelTime,
                    elapsedSeconds: elapsedSeconds.toFixed(1),
                    uploadId: this.currentUploadId,
                    isUploading: this.isUploading
                });
                
                // Immediately disable and update cancel button
                const cancelButton = document.getElementById('cancel-upload-btn');
                if (cancelButton) {
                    cancelButton.disabled = true;
                    cancelButton.style.pointerEvents = 'none';
                    cancelButton.innerHTML = '<i class="ri-loader-line animate-spin mr-1"></i>Cancelling...';
                    cancelButton.className = 'bg-gray-500 text-white px-4 py-2 rounded cursor-not-allowed text-sm';
                }
                
                // Update UI immediately with extended cleanup messaging
                const progressTitle = document.getElementById('progress-title');
                const progressMessage = document.getElementById('progress-message');
                const progressPercentage = document.getElementById('progress-percentage');
                const progressTransferred = document.getElementById('progress-transferred');
                const progressSpeed = document.getElementById('progress-speed');
                const uploadEta = document.getElementById('upload-eta');
                
                if (progressTitle) progressTitle.textContent = 'Cancelling Upload...';
                if (progressMessage) progressMessage.textContent = 'Stopping download and cleaning up. This may take 30-60 seconds for large files...';
                
                // Hide specific progress details during cancellation
                if (progressPercentage) progressPercentage.textContent = '';
                if (progressTransferred) progressTransferred.textContent = 'Cancelling...';
                if (progressSpeed) progressSpeed.textContent = '';
                if (uploadEta) uploadEta.textContent = 'Cleaning up...';
                
                // Start extended cleanup timer with status updates
                this.startCancellationProgress();
                
                // Send cancellation to backend
                if (this.currentUploadId) {
                    const cancelPayload = {
                        upload_id: this.currentUploadId,
                        frontend_cancel_time: cancelTime,
                        frontend_elapsed_seconds: elapsedSeconds,
                        immediate: true
                    };
                    
                    fetch('/api/cancel-upload', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('input[name="csrftoken"]').value,
                            'X-Priority': 'high'
                        },
                        body: JSON.stringify(cancelPayload)
                    }).then(response => {
                        console.log('Cancel response:', response.status);
                        if (progressMessage) {
                            progressMessage.textContent = 'Cancellation confirmed. Cleaning up background processes...';
                        }
                    }).catch(error => {
                        console.log('Cancel request failed:', error);
                        if (progressMessage) {
                            progressMessage.textContent = 'Cleanup in progress. Large files may take longer to stop...';
                        }
                    });
                }
                
                // Abort requests
                if (this.abortController) {
                    this.abortController.abort();
                    this.abortController = null;
                }
                
                if (this.currentXHR) {
                    this.currentXHR.abort();
                    this.currentXHR = null;
                }
                
                this.isUploading = false;
            }

            // Extended cancellation progress:
            startCancellationProgress() {
                let seconds = 0;
                const maxWaitTime = 90; // 90 seconds max wait
                const progressMessage = document.getElementById('progress-message');
                const progressTransferred = document.getElementById('progress-transferred');
                
                // Clear any existing timer
                if (this.cancelTimeoutId) {
                    clearTimeout(this.cancelTimeoutId);
                }
                
                const updateCancellationStatus = () => {
                    seconds += 2;
                    
                    if (seconds <= 10) {
                        if (progressMessage) progressMessage.textContent = 'Stopping download process...';
                        if (progressTransferred) progressTransferred.textContent = `Cancelling... ${seconds}s`;
                    } else if (seconds <= 30) {
                        if (progressMessage) progressMessage.textContent = 'Cleaning up downloaded data...';
                        if (progressTransferred) progressTransferred.textContent = `Cleanup in progress... ${seconds}s`;
                    } else if (seconds <= 60) {
                        if (progressMessage) progressMessage.textContent = 'Finalizing cancellation for large file...';
                        if (progressTransferred) progressTransferred.textContent = `Almost done... ${seconds}s`;
                    } else if (seconds <= maxWaitTime) {
                        if (progressMessage) progressMessage.textContent = 'Large file cleanup taking longer than expected...';
                        if (progressTransferred) progressTransferred.textContent = `Please wait... ${seconds}s`;
                    } else {
                        // Force close after max wait time
                        this.showResult('Upload cancelled. Cleanup completed after extended wait.', 'error');
                        setTimeout(() => {
                            this.hideProgress();
                        }, 3000);
                        return;
                    }
                    
                    // Continue updating every 2 seconds
                    this.cancelTimeoutId = setTimeout(updateCancellationStatus, 2000);
                };
                
                // Start the status updates
                updateCancellationStatus();
            }

            showResult(message, type) {
                const uploadResult = document.getElementById('upload-result');
                const resultContent = document.getElementById('upload-result-content');
                
                resultContent.innerHTML = message;
                uploadResult.className = type === 'error' ? 
                    'mt-4 p-3 rounded bg-red-100 border border-red-400 text-red-700' :
                    'mt-4 p-3 rounded bg-green-100 border border-green-400 text-green-700';
                uploadResult.classList.remove('hidden');
            }

            // File Upload via AJAX
            async uploadFile(formElement, dbName) {
                const formData = new FormData(formElement);
                const fileInput = formElement.querySelector('input[type="file"]');
                const file = fileInput.files[0];
                
                if (!file) {
                    alert('Please select a file');
                    return;
                }

                // Validate file
                if (!this.validateFile(file)) {
                    return;
                }

                // Generate and add upload ID
                this.currentUploadId = this.generateUploadId('file');
                formData.append('upload_id', this.currentUploadId);

                // Show progress with file details
                const fileSize = (file.size / 1024 / 1024).toFixed(1) + ' MB';
                this.showProgress('Uploading File', `Processing ${file.name}...`, 'file', file.name, fileSize);

                try {
                    const ajaxUrl = `/ajax-upload-file/${dbName}`;
                    const response = await this.sendAjaxRequest(ajaxUrl, formData);
                    this.handleUploadSuccess(response);
                } catch (error) {
                    this.handleUploadError(error);
                }
            }

            // Sheets Upload via AJAX
            async uploadSheets(formElement, dbName) {
                const formData = new FormData(formElement);
                const sheetsUrl = formData.get('sheets_url');
                
                if (!sheetsUrl) {
                    alert('Please enter a Google Sheets URL');
                    return;
                }

                if (!sheetsUrl.includes('docs.google.com/spreadsheets/')) {
                    alert('Please enter a valid Google Sheets URL');
                    return;
                }

                // Generate and add upload ID
                this.currentUploadId = this.generateUploadId('sheets');
                formData.append('upload_id', this.currentUploadId);

                this.showProgress('Importing Google Sheets', 'Fetching data from Google Sheets...', 'sheets');
                this.showIndeterminateProgress();

                try {
                    const ajaxUrl = `/ajax-upload-sheets/${dbName}`;
                    const response = await this.sendAjaxRequest(ajaxUrl, formData);
                    this.handleUploadSuccess(response);
                } catch (error) {
                    this.handleUploadError(error);
                }
            }

            // URL Upload via AJAX  
            async uploadUrl(formElement, dbName) {
                const formData = new FormData(formElement);
                const csvUrl = formData.get('csv_url');
                
                if (!csvUrl) {
                    alert('Please enter a CSV URL');
                    return;
                }

                try {
                    new URL(csvUrl);
                } catch {
                    alert('Please enter a valid URL');
                    return;
                }

                // Generate and add upload ID
                this.currentUploadId = this.generateUploadId('url');
                formData.append('upload_id', this.currentUploadId);

                this.showProgress('Downloading CSV', 'Fetching data from URL...', 'url');
                this.showIndeterminateProgress();

                try {
                    this.abortController = new AbortController();
                    
                    const ajaxUrl = `/ajax-upload-url/${dbName}`;
                    
                    const response = await fetch(ajaxUrl, {
                        method: 'POST',
                        body: formData,
                        signal: this.abortController.signal,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                        }
                    });

                    let result;
                    try {
                        const responseText = await response.text();
                        result = JSON.parse(responseText);
                    } catch (parseError) {
                        console.error('Failed to parse JSON response:', parseError);
                        throw new Error('Invalid response format from server');
                    }
                    
                    if (result.success) {
                        this.handleUploadSuccess(result);
                    } else {
                        this.handleUploadError(new Error(result.error));
                    }
                } catch (error) {
                    if (error.name === 'AbortError') {
                        this.showResult('Download cancelled by user', 'error');
                    } else {
                        this.handleUploadError(error);
                    }
                } finally {
                    this.currentUploadId = null;
                }
            }
            
            validateFile(file) {
                const maxSize = {{ system_settings.max_file_size }};
                if (file.size > maxSize) {
                    const maxMB = Math.floor(maxSize / (1024 * 1024));
                    alert(`File size must be less than ${maxMB}MB`);
                    return false;
                }

                const fileName = file.name.toLowerCase();
                const validExtensions = ['.csv', '.txt', '.tsv', '.xlsx', '.xls'];
                const isValidFile = validExtensions.some(ext => fileName.endsWith(ext));
                
                if (!isValidFile) {
                    alert('Please select a valid file type: CSV, TSV, TXT, or Excel (.xlsx, .xls)');
                    return false;
                }

                return true;
            }

            // AJAX request with debugging
            sendAjaxRequest(url, formData) {
                return new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    this.currentXHR = xhr;

                    xhr.open('POST', url);
                    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

                    // Track upload progress
                    xhr.upload.addEventListener('progress', (e) => {
                        if (e.lengthComputable && !this.isCancelling) {
                            this.updateProgress(e.loaded, e.total);
                        }
                    });

                    xhr.addEventListener('load', () => {
                        if (xhr.status === 200) {
                            try {
                                const response = JSON.parse(xhr.responseText);
                                resolve(response);
                            } catch (e) {
                                reject(new Error('Invalid response format'));
                            }
                        } else {
                            try {
                                const errorResponse = JSON.parse(xhr.responseText);
                                if (errorResponse.error) {
                                    reject(new Error(errorResponse.error));
                                } else {
                                    reject(new Error(`HTTP ${xhr.status}: ${xhr.statusText}`));
                                }
                            } catch (parseError) {
                                const errorText = xhr.responseText.trim();
                                if (errorText && errorText.length > 0 && errorText.length < 500) {
                                    reject(new Error(errorText));
                                } else {
                                    reject(new Error(`HTTP ${xhr.status}: ${xhr.statusText}`));
                                }
                            }
                        }
                    });

                    xhr.addEventListener('error', (e) => {
                        this.isUploading = false;
                        reject(new Error('Network error occurred'));
                    });

                    xhr.addEventListener('abort', () => {
                        this.isUploading = false;
                        reject(new Error('Upload cancelled'));
                    });

                    xhr.send(formData);
                });
            }

            handleUploadSuccess(response) {
                if (response.success) {
                    // Clear any existing timers first
                    if (this.cancelTimeoutId) {
                        clearTimeout(this.cancelTimeoutId);
                        this.cancelTimeoutId = null;
                    }
                    
                    if (this.progressTimer) {
                        clearInterval(this.progressTimer);
                        this.progressTimer = null;
                    }
                    
                    const message = `
                        <div class="flex items-center">
                            <i class="ri-check-circle-line text-green-600 text-lg mr-2"></i>
                            <div>
                                <div class="font-medium">${response.message}</div>
                                ${response.stats ? `<div class="text-xs mt-1">${response.stats}</div>` : ''}
                            </div>
                        </div>
                    `;
                    this.showResult(message, 'success');
                    
                    // Hide cancel button on success
                    const cancelButton = document.getElementById('cancel-upload-btn');
                    if (cancelButton) {
                        cancelButton.classList.add('hidden');
                    }
                    
                    // Update progress UI for success
                    const progressTitle = document.getElementById('progress-title');
                    const progressMessage = document.getElementById('progress-message');
                    if (progressTitle) progressTitle.textContent = 'Upload Complete!';
                    if (progressMessage) progressMessage.textContent = 'Redirecting to your databases...';
                    
                    // Set upload state to complete
                    this.isUploading = false;
                    this.isCancelling = false;
                    this.cancelRequested = false;
                    
                    // Redirect after showing success (with forced cleanup)
                    setTimeout(() => {
                        // Force close the dialog before redirect
                        this.hideProgress();
                        
                        // Small delay to ensure dialog is closed, then redirect
                        setTimeout(() => {
                            window.location.href = response.redirect_url || '/manage-databases';
                        }, 100);
                    }, 2000);
                } else {
                    // Handle case where response.success is false
                    this.showResult(response.error || 'Upload failed', 'error');
                    setTimeout(() => this.hideProgress(), 3000);
                }
            }

            // Update handleUploadError to show user-friendly messages:
            handleUploadError(error) {
                console.error('Upload error details:', error);
                
                this.isUploading = false;
                let errorMessage = 'Upload failed';
                let suggestions = [];
                
                if (error.message) {
                    const msg = error.message;
                    
                    // Handle specific error types with user-friendly messages
                    if (msg.includes('too large') || msg.includes('size limit')) {
                        errorMessage = 'File is too large for upload';
                        suggestions = [
                            '• Try a smaller file',
                            '• Contact administrator to increase size limit',
                            '• Consider splitting the data into multiple files'
                        ];
                    } else if (msg.includes('cancelled')) {
                        errorMessage = 'Upload was cancelled';
                        suggestions = [];
                    } else if (msg.includes('network') || msg.includes('connection')) {
                        errorMessage = 'Network connection failed';
                        suggestions = [
                            '• Check your internet connection',
                            '• Try again in a few moments',
                            '• Verify the URL is accessible'
                        ];
                    } else if (msg.includes('timeout')) {
                        errorMessage = 'Upload timed out';
                        suggestions = [
                            '• Check your internet connection',
                            '• Try a smaller file',
                            '• Try again during off-peak hours'
                        ];
                    } else if (msg.includes('format') || msg.includes('CSV')) {
                        errorMessage = 'File format is not supported';
                        suggestions = [
                            '• Ensure the file is a valid CSV',
                            '• Check that all rows have the same number of columns',
                            '• Verify the file has proper headers'
                        ];
                    } else {
                        errorMessage = msg.length > 100 ? msg.substring(0, 100) + '...' : msg;
                    }
                }
                
                // Build error display
                let errorHtml = `<div class="text-red-700">
                    <div class="font-medium mb-2">${errorMessage}</div>`;
                
                if (suggestions.length > 0) {
                    errorHtml += `
                    <div class="text-sm mt-3">
                        <div class="font-medium mb-1">What you can try:</div>
                        <div class="text-xs space-y-1">
                            ${suggestions.join('<br>')}
                        </div>
                    </div>`;
                }
                
                errorHtml += `</div>`;
                
                this.showResult(errorHtml, 'error');
                
                // Add close button
                const closeBtn = document.createElement('button');
                closeBtn.textContent = 'Close';
                closeBtn.className = 'mt-3 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 transition text-sm';
                closeBtn.onclick = () => {
                    this.hideProgress();
                };
                
                document.getElementById('upload-result-content').appendChild(closeBtn);
                
                // Update UI state
                document.getElementById('progress-icon').className = 'ri-error-warning-line text-5xl text-red-500';
                document.getElementById('progress-title').textContent = 'Upload Failed';
                document.getElementById('progress-message').textContent = '';
                document.getElementById('progress-bar').parentElement.parentElement.classList.add('hidden');
                document.getElementById('upload-details').classList.add('hidden');
                document.getElementById('cancel-upload-btn').classList.add('hidden');
            }
        }

        // Initialize upload manager
        const uploadManager = new UploadManager();

        // Tab management
        function showUploadTab(tabName) {
            const panels = document.querySelectorAll('.upload-panel');
            panels.forEach(panel => panel.classList.add('hidden'));
            
            const tabs = document.querySelectorAll('.upload-tab');
            tabs.forEach(tab => {
                tab.classList.remove('active', 'text-accent', 'border-accent');
                tab.classList.add('text-textlight');
            });
            
            document.getElementById(tabName + '-panel').classList.remove('hidden');
            
            const activeTab = document.getElementById(tabName + '-tab');
            activeTab.classList.add('active', 'text-accent', 'border-accent');
            activeTab.classList.remove('text-textlight');
        }

        // Form submission handlers
        function handleFileUpload(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const dbName = '{{ db_name }}';
            uploadManager.uploadFile(event.target, dbName);
            return false;
        }

        function handleSheetsUpload(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const dbName = '{{ db_name }}';
            uploadManager.uploadSheets(event.target, dbName);
            return false;
        }

        function handleUrlUpload(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const dbName = '{{ db_name }}';
            uploadManager.uploadUrl(event.target, dbName);
            return false;
        }

        // File selection handler
        function handleFileSelect(input) {
            const file = input.files[0];
            if (file) {
                const info = document.getElementById('file-info');
                const details = document.getElementById('file-details');
                const excelOptions = document.getElementById('excel-options');
                
                const sizeInMB = file.size / 1024 / 1024;
                let estimatedTime = '';
                if (sizeInMB > 100) {
                    estimatedTime = ` (Est. processing time: ${Math.ceil(sizeInMB / 20)}s)`;
                } else if (sizeInMB > 50) {
                    estimatedTime = ` (Est. processing time: ${Math.ceil(sizeInMB / 15)}s)`;
                }
                
                details.innerHTML = `
                    <strong>${file.name}</strong><br>
                    Size: ${sizeInMB.toFixed(2)} MB<br>
                    Type: ${file.type || 'Unknown'}${estimatedTime}
                `;
                info.classList.remove('hidden');
                
                // Show Excel info for Excel files
                const fileName = file.name.toLowerCase();
                if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                    excelOptions.classList.remove('hidden');
                } else {
                    excelOptions.classList.add('hidden');
                }
                
                // Auto-generate table name
                const tableName = document.getElementById('table-name');
                if (!tableName.value) {
                    const baseName = file.name.replace(/\.[^/.]+$/, "");
                    const cleanName = baseName.replace(/[^a-zA-Z0-9_]/g, '_').toLowerCase();
                    tableName.value = cleanName;
                }
            }
        }

        function detectSheets() {
            const url = document.getElementById('sheets-url').value;
            if (!url) {
                alert('Please enter a Google Sheets URL first.');
                return;
            }
            
            const info = document.getElementById('sheets-info');
            const details = document.getElementById('sheets-details');
            details.innerHTML = '<i class="ri-loader-line animate-spin mr-1"></i>Testing connection...';
            info.classList.remove('hidden');
            
            setTimeout(() => {
                if (url.includes('docs.google.com/spreadsheets/')) {
                    details.innerHTML = `
                        <strong><i class="ri-check-line mr-1"></i>URL format looks good!</strong><br>
                        Ready to import. Make sure the sheet is publicly accessible.
                    `;
                    info.className = 'mt-3 p-3 bg-green-50 rounded border';
                } else {
                    details.innerHTML = `
                        <strong><i class="ri-error-warning-line mr-1"></i>Invalid URL format</strong><br>
                        Please use a Google Sheets URL like: https://docs.google.com/spreadsheets/d/...
                    `;
                    info.className = 'mt-3 p-3 bg-red-50 rounded border';
                }
            }, 1500);
        }

        function validateUrl() {
            const url = document.getElementById('csv-url').value;
            if (!url) {
                alert('Please enter a URL first.');
                return;
            }
            
            const info = document.getElementById('url-info');
            const details = document.getElementById('url-details');
            details.innerHTML = '<i class="ri-loader-line animate-spin mr-1"></i>Testing URL...';
            info.classList.remove('hidden');
            
            setTimeout(() => {
                try {
                    const urlObj = new URL(url);
                    const isCSV = url.toLowerCase().includes('.csv');
                    
                    if (isCSV) {
                        details.innerHTML = `
                            <strong><i class="ri-check-line mr-1"></i>URL format looks valid!</strong><br>
                            Domain: ${urlObj.hostname}<br>
                            Backend will verify domain permissions
                        `;
                        info.className = 'mt-3 p-3 bg-blue-50 rounded border';
                    } else {
                        details.innerHTML = `
                            <strong><i class="ri-information-line mr-1"></i>Note:</strong><br>
                            URL should point to a .csv file for best results
                        `;
                        info.className = 'mt-3 p-3 bg-yellow-50 rounded border';
                    }
                } catch (e) {
                    details.innerHTML = `
                        <strong><i class="ri-error-warning-line mr-1"></i>Invalid URL format</strong><br>
                        Please enter a valid URL.
                    `;
                    info.className = 'mt-3 p-3 bg-red-50 rounded border';
                }
            }, 1000);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            showUploadTab('file');
            
            // Clear any stuck progress dialogs on page load
            const overlay = document.getElementById('upload-progress-overlay');
            if (overlay && !overlay.classList.contains('hidden')) {
                console.log('Clearing stuck progress dialog on page load');
                uploadManager.hideProgress();
            }
            
            // Single, improved cancel button handler
            const cancelButton = document.getElementById('cancel-upload-btn');
            if (cancelButton) {
                cancelButton.addEventListener('click', (event) => {
                    // Prevent multiple clicks
                    event.preventDefault();
                    event.stopPropagation();
                    
                    console.log('Cancel button clicked');
                    
                    // Check if already cancelling
                    if (uploadManager.isCancelling || uploadManager.cancelRequested) {
                        console.log('Already cancelling, ignoring click');
                        return;
                    }
                    
                    // Check if actually uploading
                    if (!uploadManager.isUploading || !uploadManager.currentUploadId) {
                        console.log('No active upload to cancel');
                        return;
                    }
                    
                    // Immediately disable button to prevent multiple clicks
                    cancelButton.disabled = true;
                    cancelButton.style.pointerEvents = 'none';
                    
                    // Call cancellation
                    uploadManager.cancelUpload();
                });
            }
            
            // Prevent form submissions if cancelling
            document.addEventListener('submit', function(event) {
                if (uploadManager.isCancelling || uploadManager.cancelRequested) {
                    event.preventDefault();
                    console.log('Prevented form submission during cancellation');
                }
            });
            
            // Add keyboard support for cancellation (ESC key)
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape' && uploadManager.isUploading && !uploadManager.isCancelling) {
                    console.log('ESC key pressed - cancelling upload');
                    uploadManager.cancelUpload();
                }
            });
            
            // Prevent page unload during upload
            window.addEventListener('beforeunload', function(event) {
                if (uploadManager.isUploading && !uploadManager.isCancelling) {
                    event.preventDefault();
                    event.returnValue = 'Upload in progress. Are you sure you want to leave?';
                    return 'Upload in progress. Are you sure you want to leave?';
                }
            });
        });
    </script>

    <style>
        .upload-tab.active {
            border-bottom: 2px solid theme('colors.accent');
        }
        .upload-tab:not(.active) {
            border-bottom: 2px solid transparent;
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        button:disabled {
            transform: none !important;
        }
        
        #upload-progress-overlay {
            backdrop-filter: blur(4px);
        }
    </style>
</body>
</html>