<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.9">
    <title>Upload Data - {{ db_name }} | EDGI Portal</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script src="/static/js/tailwind.config.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="icon" href="/static/favicon.ico">
</head>
<body class="bg-background">
    <header class="fixed top-0 left-0 right-0 z-50 bg-header text-white shadow-md">
        <div class="container mx-auto px-4 h-20 flex items-center justify-between">
            <div class="flex items-center">
                <div class="w-10 h-10 flex items-center justify-center mr-3">
                    <i class="ri-upload-cloud-line text-white ri-2x" aria-hidden="true"></i>
                </div>
                <div class="text-xl font-semibold">Upload Data to {{ db_name.replace('_', ' ').title() }}</div>
            </div>
            <div>
                <a href="/manage-databases" class="text-white hover:text-accent mr-4">
                    <i class="ri-arrow-left-line mr-1"></i>Back to Databases
                </a>
                <a href="/logout" class="text-white hover:text-accent">Logout</a>
            </div>
        </div>
    </header>
    
    <main class="flex-grow pt-20 pb-6">
        <section class="container mx-auto px-4 mt-6">
            <div class="max-w-4xl mx-auto">
                <!-- Header -->
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-primary mb-4">Upload Data</h1>
                    <p class="text-textlight">Add data to your {{ db_name.replace('_', ' ').title() }} database from multiple sources</p>
                </div>

                <!-- Success/Error Messages -->
                {% if success %}
                    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-6">
                        <!-- Decode URL-encoded success messages and preserve formatting -->
                        {% set decoded_success = success|urldecode %}
                        {% if "ULTRA-FAST:" in decoded_success or "Successfully uploaded" in decoded_success %}
                            <!-- Enhanced display for upload success with statistics -->
                            <div class="flex items-center">
                                <i class="ri-check-circle-line text-green-600 text-lg mr-2"></i>
                                <div>
                                    <p class="text-sm font-medium">{{ decoded_success }}</p>
                                    {% if "rows/sec" in decoded_success %}
                                        <p class="text-xs text-green-600 mt-1">
                                            <i class="ri-dashboard-3-line mr-1"></i>
                                            High-performance upload completed successfully
                                        </p>
                                    {% endif %}
                                </div>
                            </div>
                        {% else %}
                            <!-- Standard success message display -->
                            <p class="text-sm">{{ decoded_success }}</p>
                        {% endif %}
                    </div>
                {% endif %}

                {% if error %}
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
                        <!-- Decode URL-encoded error messages -->
                        {% set decoded_error = error|urldecode %}
                        <p class="text-sm font-medium">{{ decoded_error }}</p>
                        
                        <!-- Enhanced error guidance -->
                        {% if "Google Sheet is private" in decoded_error %}
                            <div class="mt-2 text-xs">
                                <strong>How to fix:</strong> 
                                <ol class="list-decimal list-inside mt-1">
                                    <li>Open your Google Sheet</li>
                                    <li>Click "Share" button (top right)</li>
                                    <li>Change to "Anyone with the link can view"</li>
                                    <li>Copy the share link and try again</li>
                                </ol>
                            </div>
                        {% elif "Domain" in decoded_error and "blocked" in decoded_error %}
                            <div class="mt-2 text-xs">
                                <strong>Domain blocked:</strong> Contact admin to request domain approval.
                            </div>
                        {% elif "type 'Timestamp' is not supported" in decoded_error %}
                            <div class="mt-2 text-xs">
                                <strong>How to fix:</strong> This Excel file contains date/time columns that need to be converted. Try saving as CSV first, or the system will automatically convert them on retry.
                            </div>
                        {% endif %}
                    </div>
                {% endif %}

                <!-- Upload Progress Overlay with Real Progress Bar -->
                <div id="upload-progress-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                        <div class="text-center">
                            <div class="mb-4">
                                <i id="progress-icon" class="ri-upload-cloud-line text-5xl text-blue-500"></i>
                            </div>
                            <h3 class="text-lg font-semibold mb-2" id="progress-title">Processing Upload...</h3>
                            <p class="text-gray-600 text-sm mb-4" id="progress-message">Please wait while your data is being processed.</p>
                            
                            <!-- Real Progress Bar -->
                            <div class="mb-4">
                                <div class="flex justify-between text-xs text-gray-600 mb-1">
                                    <span id="progress-percentage">0%</span>
                                    <span id="progress-speed"></span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div id="progress-bar" class="bg-blue-500 h-3 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
                                </div>
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span id="progress-transferred">0 MB / 0 MB</span>
                                    <span id="progress-time">Elapsed: 0s</span>
                                </div>
                            </div>
                            
                            <!-- Upload Details -->
                            <div id="upload-details" class="text-xs text-gray-600 mb-4 hidden">
                                <div class="flex justify-between">
                                    <span>File:</span>
                                    <span id="upload-filename"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Size:</span>
                                    <span id="upload-filesize"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span>ETA:</span>
                                    <span id="upload-eta">Calculating...</span>
                                </div>
                            </div>
                            
                            <!-- Cancel Button -->
                            <button id="cancel-upload-btn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition text-sm">
                                <i class="ri-close-line mr-1"></i>Cancel Upload
                            </button>
                            
                            <!-- Success/Error Display -->
                            <div id="upload-result" class="hidden mt-4 p-3 rounded">
                                <div id="upload-result-content"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload Source Tabs -->
                <div class="bg-card rounded-card border border-border mb-6">
                    <div class="border-b border-border">
                        <nav class="flex">
                            <button onclick="showUploadTab('file')" id="file-tab" 
                                    class="upload-tab active px-6 py-4 font-medium text-accent border-b-2 border-accent">
                                <i class="ri-file-upload-line mr-2"></i>Upload File
                            </button>
                            <button onclick="showUploadTab('sheets')" id="sheets-tab" 
                                    class="upload-tab px-6 py-4 font-medium text-textlight hover:text-accent">
                                <i class="ri-table-line mr-2"></i>Google Sheets
                            </button>
                            <button onclick="showUploadTab('url')" id="url-tab" 
                                    class="upload-tab px-6 py-4 font-medium text-textlight hover:text-accent">
                                <i class="ri-global-line mr-2"></i>Web CSV
                            </button>
                        </nav>
                    </div>

                    <!-- File Upload Panel - Updated for AJAX -->
                    <div id="file-panel" class="upload-panel p-6">
                        <form id="file-upload-form" onsubmit="return handleFileUpload(event)">
                            <input type="hidden" name="csrftoken" value="{{ csrftoken() }}">
                            <input type="hidden" name="source_type" value="file">
                            
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- File Selection -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Select File
                                    </label>
                                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-accent transition">
                                        <input type="file" name="file" id="file-input" 
                                            accept=".csv,.txt,.tsv,.xlsx,.xls" 
                                            class="hidden" onchange="handleFileSelect(this)">
                                        <label for="file-input" class="cursor-pointer">
                                            <i class="ri-upload-cloud-2-line text-4xl text-gray-400 mb-2 block"></i>
                                            <p class="text-gray-600">Click to select file</p>
                                            <p class="text-xs text-gray-500 mt-1">Supports CSV, TSV, TXT, Excel (.xlsx, .xls) files up to {{ (system_settings.max_file_size // (1024*1024)) }}MB</p>
                                        </label>
                                        <div id="file-info" class="hidden mt-4 p-3 bg-blue-50 rounded border">
                                            <p class="text-sm text-blue-800" id="file-details"></p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Upload Options -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Table Name (Optional)
                                    </label>
                                    <input type="text" name="table_name" id="table-name" 
                                        class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-accent"
                                        placeholder="Auto-generated from filename">
                                    <p class="text-xs text-gray-500 mt-1">Leave blank to use filename. Must be unique in database.</p>

                                    <!-- Excel Sheet Selection -->
                                    <div id="excel-options" class="hidden mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Excel Sheet (Optional)
                                        </label>
                                        <select name="excel_sheet" id="excel-sheet-select" 
                                                class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-accent">
                                            <option value="">First sheet (default)</option>
                                        </select>
                                        <p class="text-xs text-gray-500 mt-1">Select specific sheet from Excel workbook.</p>
                                    </div>

                                    <div class="mt-4">
                                        <label class="flex items-center">
                                            <input type="checkbox" name="replace_existing" class="mr-2">
                                            <span class="text-sm text-gray-700">Replace existing table if name conflicts</span>
                                        </label>
                                    </div>

                                    <div class="mt-6">
                                        <button type="submit" id="file-upload-btn"
                                                class="w-full bg-accent text-white py-3 px-4 rounded-button hover:bg-primary transition font-medium">
                                            <i class="ri-upload-line mr-2" id="file-upload-icon"></i>
                                            <span id="file-upload-text">Upload File</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Google Sheets Panel - Updated for AJAX -->
                    <div id="sheets-panel" class="upload-panel p-6 hidden">
                        <form id="sheets-upload-form" onsubmit="return handleSheetsUpload(event)">
                            <input type="hidden" name="csrftoken" value="{{ csrftoken() }}">
                            <input type="hidden" name="source_type" value="sheets">
                            
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- Google Sheets URL -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Google Sheets URL
                                    </label>
                                    <input type="url" name="sheets_url" id="sheets-url" 
                                        class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-accent"
                                        placeholder="https://docs.google.com/spreadsheets/d/...">
                                    <div class="text-xs text-gray-500 mt-1">
                                        <p><strong>Important:</strong> The sheet must be publicly accessible.</p>
                                        <p class="mt-1"><strong>How to share:</strong></p>
                                        <ol class="list-decimal list-inside mt-1">
                                            <li>Open your Google Sheet</li>
                                            <li>Click "Share" (top right)</li>
                                            <li>Change to "Anyone with the link can view"</li>
                                            <li>Copy the link and paste it here</li>
                                        </ol>
                                    </div>

                                    <!-- Sheet Detection -->
                                    <div class="mt-4">
                                        <button type="button" onclick="detectSheets()" 
                                                class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition text-sm">
                                            <i class="ri-search-line mr-1"></i>Test Connection
                                        </button>
                                        <div id="sheets-info" class="hidden mt-3 p-3 bg-green-50 rounded border">
                                            <p class="text-sm text-green-800" id="sheets-details"></p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Import Options -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Sheet Selection
                                    </label>
                                    <select name="sheet_index" id="sheet-select" 
                                            class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-accent">
                                        <option value="0">First Sheet (Default)</option>
                                    </select>

                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Table Name (Optional)
                                        </label>
                                        <input type="text" name="table_name" id="sheets-table-name" 
                                            class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-accent"
                                            placeholder="Auto-generated from sheet name">
                                    </div>

                                    <div class="mt-4">
                                        <label class="flex items-center">
                                            <input type="checkbox" name="first_row_headers" checked class="mr-2">
                                            <span class="text-sm text-gray-700">First row contains headers</span>
                                        </label>
                                    </div>

                                    <div class="mt-6">
                                        <button type="submit" id="sheets-upload-btn"
                                                class="w-full bg-accent text-white py-3 px-4 rounded-button hover:bg-primary transition font-medium">
                                            <i class="ri-download-cloud-line mr-2" id="sheets-upload-icon"></i>
                                            <span id="sheets-upload-text">Import from Google Sheets</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Web CSV Panel - Updated for AJAX -->
                    <div id="url-panel" class="upload-panel p-6 hidden">
                        <form id="url-upload-form" onsubmit="return handleUrlUpload(event)">
                            <input type="hidden" name="csrftoken" value="{{ csrftoken() }}">
                            <input type="hidden" name="source_type" value="url">
                            
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- URL Input -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        CSV File URL
                                    </label>
                                    <input type="url" name="csv_url" id="csv-url" 
                                        class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-accent"
                                        placeholder="https://example.com/data.csv">
                                    <div class="text-xs text-gray-500 mt-1">
                                        <p><strong>Supported:</strong> Most domains are allowed unless blocked by admin.</p>
                                        <p class="mt-1">URL must point directly to a CSV file. Raw URLs work best.</p>
                                        <p class="mt-1">Contact admin if your domain is blocked.</p>
                                    </div>

                                    <!-- URL Validation -->
                                    <div class="mt-4">
                                        <button type="button" onclick="validateUrl()" 
                                                class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition text-sm">
                                            <i class="ri-check-line mr-1"></i>Test URL
                                        </button>
                                        <div id="url-info" class="hidden mt-3 p-3 bg-green-50 rounded border">
                                            <p class="text-sm text-green-800" id="url-details"></p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Import Options -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Table Name (Optional)
                                    </label>
                                    <input type="text" name="table_name" id="url-table-name" 
                                        class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-accent"
                                        placeholder="Auto-generated from URL">

                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            Encoding
                                        </label>
                                        <select name="encoding" class="w-full p-3 border border-gray-300 rounded">
                                            <option value="auto">Auto-detect</option>
                                            <option value="utf-8">UTF-8</option>
                                            <option value="latin-1">Latin-1</option>
                                            <option value="ascii">ASCII</option>
                                        </select>
                                    </div>

                                    <div class="mt-6">
                                        <button type="submit" id="url-upload-btn"
                                                class="w-full bg-accent text-white py-3 px-4 rounded-button hover:bg-primary transition font-medium">
                                            <i class="ri-download-line mr-2" id="url-upload-icon"></i>
                                            <span id="url-upload-text">Import from URL</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Enhanced Help Section -->
                <div class="bg-blue-50 border border-blue-200 rounded-card p-6 mt-6">
                    <h3 class="text-lg font-semibold text-blue-800 mb-4">
                        <i class="ri-information-line mr-2"></i>Upload Guidelines & Troubleshooting
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-blue-700">
                        <div>
                            <div class="font-semibold text-blue-800 mb-2">File Uploads</div>
                            <ul class="space-y-1">
                                <li>• Maximum file size: {{ (system_settings.max_file_size // (1024*1024)) }}MB</li>
                                <li>• Supported formats: CSV, TSV, TXT</li>
                                <li>• Excel files: .xlsx, .xls</li>
                                <li>• UTF-8 encoding recommended</li>
                                <li>• First row should contain headers</li>
                            </ul>
                            <div class="mt-2 text-xs">
                                <strong>Performance:</strong> Ultra-optimized processing for large files (100MB+) with speeds up to 150,000+ rows/sec.
                            </div>
                        </div>
                        <div>
                            <div class="font-semibold text-blue-800 mb-2">Google Sheets</div>
                            <ul class="space-y-1">
                                <li>• Sheet must be publicly accessible</li>
                                <li>• Use "Anyone with link can view"</li>
                                <li>• Supports multiple sheets per document</li>
                                <li>• Automatically detects data ranges</li>
                            </ul>
                            <div class="mt-2 text-xs">
                                <strong>Common Issue:</strong> 401 Unauthorized means the sheet is private. Make it public to fix.
                            </div>
                        </div>
                        <div>
                            <div class="font-semibold text-blue-800 mb-2">Web CSV</div>
                            <ul class="space-y-1">
                                <li>• Most domains are supported</li>
                                <li>• Must point directly to CSV file</li>
                                <li>• Raw URLs work best</li>
                                <li>• Some domains may be blocked by admin</li>
                            </ul>
                            <div class="mt-2 text-xs">
                                <strong>Domain Blocked?</strong> Contact admin if your domain is restricted.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        class UploadManager {
            constructor() {
                this.currentXHR = null;
                this.startTime = null;
                this.progressTimer = null;
                this.isUploading = false;
            }

            showProgress(title, message, type = 'file', filename = '', filesize = '') {
                const overlay = document.getElementById('upload-progress-overlay');
                const progressTitle = document.getElementById('progress-title');
                const progressMessage = document.getElementById('progress-message');
                const progressIcon = document.getElementById('progress-icon');
                const uploadDetails = document.getElementById('upload-details');
                const uploadFilename = document.getElementById('upload-filename');
                const uploadFilesize = document.getElementById('upload-filesize');
                const uploadResult = document.getElementById('upload-result');

                // Set content
                progressTitle.textContent = title;
                progressMessage.textContent = message;
                
                // Set appropriate icon
                const iconClass = type === 'sheets' ? 'ri-table-line' : 
                                type === 'url' ? 'ri-global-line' : 'ri-upload-cloud-line';
                progressIcon.className = `${iconClass} text-5xl text-blue-500`;
                
                // Show file details for file uploads
                if (filename && filesize) {
                    uploadFilename.textContent = filename;
                    uploadFilesize.textContent = filesize;
                    uploadDetails.classList.remove('hidden');
                } else {
                    uploadDetails.classList.add('hidden');
                }
                
                // Reset progress
                this.resetProgress();
                uploadResult.classList.add('hidden');
                
                // Show overlay
                overlay.classList.remove('hidden');
                this.isUploading = true;
                this.startTime = Date.now();
                this.startTimer();
            }

            hideProgress() {
                const overlay = document.getElementById('upload-progress-overlay');
                overlay.classList.add('hidden');
                
                if (this.progressTimer) {
                    clearInterval(this.progressTimer);
                    this.progressTimer = null;
                }
                
                this.isUploading = false;
                this.currentXHR = null;
            }

            resetProgress() {
                document.getElementById('progress-bar').style.width = '0%';
                document.getElementById('progress-percentage').textContent = '0%';
                document.getElementById('progress-transferred').textContent = '0 MB / 0 MB';
                document.getElementById('progress-speed').textContent = '';
                document.getElementById('upload-eta').textContent = 'Calculating...';
            }

            updateProgress(loaded, total) {
                if (!this.isUploading) return;

                const percentage = Math.round((loaded / total) * 100);
                const loadedMB = (loaded / 1024 / 1024).toFixed(1);
                const totalMB = (total / 1024 / 1024).toFixed(1);
                
                // Update progress bar
                document.getElementById('progress-bar').style.width = percentage + '%';
                document.getElementById('progress-percentage').textContent = percentage + '%';
                document.getElementById('progress-transferred').textContent = `${loadedMB} MB / ${totalMB} MB`;
                
                // Calculate speed and ETA
                const elapsed = (Date.now() - this.startTime) / 1000;
                const speed = loaded / elapsed; // bytes per second
                const speedMBs = (speed / 1024 / 1024).toFixed(1);
                const remaining = (total - loaded) / speed;
                
                document.getElementById('progress-speed').textContent = `${speedMBs} MB/s`;
                
                if (remaining > 0 && remaining < Infinity) {
                    const eta = remaining < 60 ? `${Math.round(remaining)}s` : 
                            remaining < 3600 ? `${Math.round(remaining/60)}m` : 
                            `${Math.round(remaining/3600)}h`;
                    document.getElementById('upload-eta').textContent = eta;
                }
            }

            startTimer() {
                const progressTime = document.getElementById('progress-time');
                this.progressTimer = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                    progressTime.textContent = `Elapsed: ${elapsed}s`;
                }, 1000);
            }

                cancelUpload() {
                    console.log('Cancelling upload...');
                    
                    // Cancel any ongoing fetch requests
                    if (this.abortController) {
                        this.abortController.abort();
                        this.abortController = null;
                    }
                    
                    // Cancel XHR requests
                    if (this.currentXHR) {
                        this.currentXHR.abort();
                        this.currentXHR = null;
                    }
                    
                    // Clear timers
                    if (this.progressTimer) {
                        clearInterval(this.progressTimer);
                        this.progressTimer = null;
                    }
                    
                    this.isUploading = false;
                    this.showResult('Upload cancelled', 'error');
                    
                    // Hide progress after 2 seconds
                    setTimeout(() => {
                        this.hideProgress();
                    }, 2000);
                }

            showResult(message, type) {
                const uploadResult = document.getElementById('upload-result');
                const resultContent = document.getElementById('upload-result-content');
                
                resultContent.innerHTML = message;
                uploadResult.className = type === 'error' ? 
                    'mt-4 p-3 rounded bg-red-100 border border-red-400 text-red-700' :
                    'mt-4 p-3 rounded bg-green-100 border border-green-400 text-green-700';
                uploadResult.classList.remove('hidden');
            }

            // File Upload via AJAX
            async uploadFile(formElement, dbName) {
                const formData = new FormData(formElement);
                const fileInput = formElement.querySelector('input[type="file"]');
                const file = fileInput.files[0];
                
                if (!file) {
                    alert('Please select a file');
                    return;
                }

                // Validate file
                if (!this.validateFile(file)) {
                    return;
                }

                // Show progress with file details
                const fileSize = (file.size / 1024 / 1024).toFixed(1) + ' MB';
                this.showProgress('Uploading File', `Processing ${file.name}...`, 'file', file.name, fileSize);

                try {
                    const response = await this.sendAjaxRequest(`/ajax-upload-file/${dbName}`, formData);
                    this.handleUploadSuccess(response);
                } catch (error) {
                    this.handleUploadError(error);
                }
            }

            // Google Sheets Upload via AJAX - with debugging
            async uploadSheets(formElement, dbName) {
                const formData = new FormData(formElement);
                const sheetsUrl = formData.get('sheets_url');
                
                console.log('Form data contents:');
                for (let [key, value] of formData.entries()) {
                    console.log(`${key}: ${value}`);
                }
                
                if (!sheetsUrl) {
                    alert('Please enter a Google Sheets URL');
                    return;
                }

                if (!sheetsUrl.includes('docs.google.com/spreadsheets/')) {
                    alert('Please enter a valid Google Sheets URL');
                    return;
                }

                this.showProgress('Importing Google Sheets', 'Fetching data from Google Sheets...', 'sheets');

                try {
                    const response = await this.sendAjaxRequest(`/ajax-upload-sheets/${dbName}`, formData);
                    this.handleUploadSuccess(response);
                } catch (error) {
                    console.error('Sheets upload error:', error);
                    this.handleUploadError(error);
                }
            }

            // URL Upload via AJAX - with debugging  
            async uploadUrl(formElement, dbName) {
                const formData = new FormData(formElement);
                const csvUrl = formData.get('csv_url');
                
                if (!csvUrl) {
                    alert('Please enter a CSV URL');
                    return;
                }

                try {
                    new URL(csvUrl);
                } catch {
                    alert('Please enter a valid URL');
                    return;
                }

                // FIXED: Show progress immediately for URL downloads
                this.showProgress('Downloading CSV', 'Fetching data from URL...', 'url');

                try {
                    // FIXED: Add abort controller for cancellation
                    this.abortController = new AbortController();
                    
                    const response = await fetch(`/ajax-upload-url/${dbName}`, {
                        method: 'POST',
                        body: formData,
                        signal: this.abortController.signal  // Enable cancellation
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        this.handleUploadSuccess(result);
                    } else {
                        this.handleUploadError(new Error(result.error));
                    }
                } catch (error) {
                    if (error.name === 'AbortError') {
                        this.showResult('Download cancelled by user', 'error');
                    } else {
                        this.handleUploadError(error);
                    }
                }
            }

            validateFile(file) {
                const maxSize = {{ system_settings.max_file_size }};
                if (file.size > maxSize) {
                    const maxMB = Math.floor(maxSize / (1024 * 1024));
                    alert(`File size must be less than ${maxMB}MB`);
                    return false;
                }

                const fileName = file.name.toLowerCase();
                const validExtensions = ['.csv', '.txt', '.tsv', '.xlsx', '.xls'];
                const isValidFile = validExtensions.some(ext => fileName.endsWith(ext));
                
                if (!isValidFile) {
                    alert('Please select a valid file type: CSV, TSV, TXT, or Excel (.xlsx, .xls)');
                    return false;
                }

                return true;
            }

            // AJAX request with debugging
            sendAjaxRequest(url, formData) {
                return new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    this.currentXHR = xhr;

                    console.log(`Making AJAX request to: ${url}`);
                    
                    // Log form data being sent
                    console.log('Sending form data:');
                    for (let [key, value] of formData.entries()) {
                        console.log(`  ${key}: ${value}`);
                    }

                    // Track upload progress
                    xhr.upload.addEventListener('progress', (e) => {
                        if (e.lengthComputable) {
                            this.updateProgress(e.loaded, e.total);
                        }
                    });

                    xhr.addEventListener('load', () => {
                        console.log(`Response status: ${xhr.status}`);
                        console.log(`Response text: ${xhr.responseText}`);
                        
                        if (xhr.status === 200) {
                            try {
                                const response = JSON.parse(xhr.responseText);
                                resolve(response);
                            } catch (e) {
                                console.error('JSON parse error:', e);
                                reject(new Error('Invalid response format'));
                            }
                        } else {
                            reject(new Error(`HTTP ${xhr.status}: ${xhr.statusText}`));
                        }
                    });

                    xhr.addEventListener('error', (e) => {
                        console.error('XHR error:', e);
                        reject(new Error('Network error occurred'));
                    });

                    xhr.addEventListener('abort', () => {
                        reject(new Error('Upload cancelled'));
                    });

                    xhr.open('POST', url);
                    // Don't set Content-Type header - let browser set it with boundary
                    xhr.send(formData);
                });
            }

            handleUploadSuccess(response) {
                if (response.success) {
                    const message = `
                        <div class="flex items-center">
                            <i class="ri-check-circle-line text-green-600 text-lg mr-2"></i>
                            <div>
                                <div class="font-medium">${response.message}</div>
                                ${response.stats ? `<div class="text-xs mt-1">${response.stats}</div>` : ''}
                            </div>
                        </div>
                    `;
                    this.showResult(message, 'success');
                    
                    // Redirect after showing success
                    setTimeout(() => {
                        window.location.href = response.redirect_url || '/manage-databases';
                    }, 2000);
                } else {
                    this.showResult(response.error || 'Upload failed', 'error');
                    setTimeout(() => this.hideProgress(), 3000);
                }
            }

            handleUploadError(error) {
                console.error('Upload error details:', error);
                
                let errorMessage = 'Upload failed';
                if (error.message.includes('timeout') || error.message.includes('Timeout')) {
                    errorMessage = 'Upload timed out - file may be too large or server too slow';
                } else if (error.message.includes('Network error')) {
                    errorMessage = 'Network connection failed - check your internet connection';
                } else if (error.message.includes('cancelled')) {
                    errorMessage = 'Upload was cancelled';
                } else {
                    errorMessage = `Upload failed: ${error.message}`;
                }
                
                this.showResult(errorMessage, 'error');
                setTimeout(() => this.hideProgress(), 3000);
            }
        }

        // Initialize upload manager
        const uploadManager = new UploadManager();

        // Tab management
        function showUploadTab(tabName) {
            const panels = document.querySelectorAll('.upload-panel');
            panels.forEach(panel => panel.classList.add('hidden'));
            
            const tabs = document.querySelectorAll('.upload-tab');
            tabs.forEach(tab => {
                tab.classList.remove('active', 'text-accent', 'border-accent');
                tab.classList.add('text-textlight');
            });
            
            document.getElementById(tabName + '-panel').classList.remove('hidden');
            
            const activeTab = document.getElementById(tabName + '-tab');
            activeTab.classList.add('active', 'text-accent', 'border-accent');
            activeTab.classList.remove('text-textlight');
        }

        // Form submission handlers
        function handleFileUpload(event) {
            event.preventDefault();
            const dbName = '{{ db_name }}';
            uploadManager.uploadFile(event.target, dbName);
            return false;
        }

        function handleSheetsUpload(event) {
            event.preventDefault();
            const dbName = '{{ db_name }}';
            uploadManager.uploadSheets(event.target, dbName);
            return false;
        }

        function handleUrlUpload(event) {
            event.preventDefault();
            const dbName = '{{ db_name }}';
            uploadManager.uploadUrl(event.target, dbName);
            return false;
        }

        // File selection handler
        function handleFileSelect(input) {
            const file = input.files[0];
            if (file) {
                const info = document.getElementById('file-info');
                const details = document.getElementById('file-details');
                const excelOptions = document.getElementById('excel-options');
                
                const sizeInMB = file.size / 1024 / 1024;
                let estimatedTime = '';
                if (sizeInMB > 100) {
                    estimatedTime = ` (Est. processing time: ${Math.ceil(sizeInMB / 20)}s)`;
                } else if (sizeInMB > 50) {
                    estimatedTime = ` (Est. processing time: ${Math.ceil(sizeInMB / 15)}s)`;
                }
                
                details.innerHTML = `
                    <strong>${file.name}</strong><br>
                    Size: ${sizeInMB.toFixed(2)} MB<br>
                    Type: ${file.type || 'Unknown'}${estimatedTime}
                `;
                info.classList.remove('hidden');
                
                const fileName = file.name.toLowerCase();
                if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                    excelOptions.classList.remove('hidden');
                } else {
                    excelOptions.classList.add('hidden');
                }
                
                const tableName = document.getElementById('table-name');
                if (!tableName.value) {
                    const baseName = file.name.replace(/\.[^/.]+$/, "");
                    const cleanName = baseName.replace(/[^a-zA-Z0-9_]/g, '_').toLowerCase();
                    tableName.value = cleanName;
                }
            }
        }

        function detectSheets() {
            const url = document.getElementById('sheets-url').value;
            if (!url) {
                alert('Please enter a Google Sheets URL first.');
                return;
            }
            
            const info = document.getElementById('sheets-info');
            const details = document.getElementById('sheets-details');
            details.innerHTML = '<i class="ri-loader-line animate-spin mr-1"></i>Testing connection...';
            info.classList.remove('hidden');
            
            setTimeout(() => {
                if (url.includes('docs.google.com/spreadsheets/')) {
                    details.innerHTML = `
                        <strong><i class="ri-check-line mr-1"></i>URL format looks good!</strong><br>
                        Ready to import. Make sure the sheet is publicly accessible.
                    `;
                    info.className = 'mt-3 p-3 bg-green-50 rounded border';
                } else {
                    details.innerHTML = `
                        <strong><i class="ri-error-warning-line mr-1"></i>Invalid URL format</strong><br>
                        Please use a Google Sheets URL like: https://docs.google.com/spreadsheets/d/...
                    `;
                    info.className = 'mt-3 p-3 bg-red-50 rounded border';
                }
            }, 1500);
        }

        function validateUrl() {
            const url = document.getElementById('csv-url').value;
            if (!url) {
                alert('Please enter a URL first.');
                return;
            }
            
            const info = document.getElementById('url-info');
            const details = document.getElementById('url-details');
            details.innerHTML = '<i class="ri-loader-line animate-spin mr-1"></i>Testing URL...';
            info.classList.remove('hidden');
            
            setTimeout(() => {
                try {
                    const urlObj = new URL(url);
                    const isCSV = url.toLowerCase().includes('.csv');
                    
                    if (isCSV) {
                        details.innerHTML = `
                            <strong><i class="ri-check-line mr-1"></i>URL format looks valid!</strong><br>
                            Domain: ${urlObj.hostname}<br>
                            Backend will verify domain permissions
                        `;
                        info.className = 'mt-3 p-3 bg-blue-50 rounded border';
                    } else {
                        details.innerHTML = `
                            <strong><i class="ri-information-line mr-1"></i>Note:</strong><br>
                            URL should point to a .csv file for best results
                        `;
                        info.className = 'mt-3 p-3 bg-yellow-50 rounded border';
                    }
                } catch (e) {
                    details.innerHTML = `
                        <strong><i class="ri-error-warning-line mr-1"></i>Invalid URL format</strong><br>
                        Please enter a valid URL.
                    `;
                    info.className = 'mt-3 p-3 bg-red-50 rounded border';
                }
            }, 1000);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            showUploadTab('file');
            
            // Cancel upload handler
            document.getElementById('cancel-upload-btn').addEventListener('click', () => {
                uploadManager.cancelUpload();
            });
        });
    </script>

    <style>
        .upload-tab.active {
            border-bottom: 2px solid theme('colors.accent');
        }
        .upload-tab:not(.active) {
            border-bottom: 2px solid transparent;
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .animate-bounce {
            animation: bounce 1s infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% {
                transform: translate3d(0,0,0);
            }
            40%, 43% {
                transform: translate3d(0,-30px,0);
            }
            70% {
                transform: translate3d(0,-15px,0);
            }
            90% {
                transform: translate3d(0,-4px,0);
            }
        }

        button:disabled {
            transform: none !important;
        }
        
        #upload-progress-overlay {
            backdrop-filter: blur(4px);
        }
    </style>
</body>
</html>